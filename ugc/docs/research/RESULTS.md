# Тестирование


## Eventbuses

* `Kafka`
* `Rabbitmq`


### Условия

На тестовом стенде для запущенного инстанса UGC попеременно подключались кластера `Kafka` и `Rabbitmq`, состоящие из 3 нод. Для данных конфигураций на вход UGC подвалась нагрузка с средним значением 120 rps. Выход eventbus'ов читался соответсвующим ридером, измерялось среднее время между получением eventbus'ом события и его фактическим прочтением.


### Результаты

95 прецентиль времени ответа сервера составляет 97 ms для Kafka и 86 ms для Rabbit. При этом среднее время между получением события и его фактическим прочтением состаляет ~7 ms для Kafka и ~500 ms для Rabbit. Отметим, что по умолчанию Rabbit не предоставляет метку времени получения события. Да, можно установить доп. плагин для добавления метки в header, но это не будет являтся точным время его получения + есть проблемы с подбром версии ядра кролика, конфигурацией кластера и тд. В случае Rabbit'а измерялась разница между серверным временем отправки события и его фактическим прочтением. Возможно поэтому разница столь существенна. Также стоит отметить, что по умолчанию Rabbit не предполагает хранения событий внутри себя и больше оринтирован на выполнение ф-ий брокера, в то время как Kafka является полноценным eventbus'ом (OLTP-хранилищем событий).


### Вывод

Для наших целей и задач рекомендуется использовать Kafka.


## OLAPs

* `Clickhouse`
* `Vertica`

### Условия

Для разработанного дизайна данных сервиса UGC (`examples.json`) подготовлена схема данных `schemas.py`. При каждом запуске испытания заново создавалась не шардированная и не реплицированная база данных в одном `docker` контейнере. Результаты считаются по 10 итерациям, как средние арифметические. Ошибки отсутствовали.

### Результаты (Clickhouse \ Vertica)

На одновременной загрузке наилучший результат показал `Clickhouse` с результатом 1500 строк.

| Bulk size | Общее время загрузки, микросек. | Среднее время загрузки 1 строки, микросек.|
|:--------: |:-------------------------------:| :----------------------------------------:|
| 1         | 13004 \ 84244                   | 13004 \ 84244                             |
| 5         | 17402 \ 234314                  | 3480 \ 46863                              |
| 10        | 20458 \ 382881                  | 2046 \ 38288                              |
| 50        | 51771 \ 700046                  | 1035 \ 14001                              |
| 100       | 86724 \ 341826                  | 867 \ 3418                                |
| 200       | 160726 \ 714278                 | 804 \ 3571                                |
| 300       | 227190 \ 315893                 | 757 \ 1053                                |
| 400       | 292488 \ 772073                 | 731 \ 1930                                |
| 500       | 368020 \ 405489                 | 736 \ 811                                 |
| 600       | 430776 \ 451788                 | 718 \ 753                                 |
| 700       | 493735 \ 490679                 | 705 \ 701                                 |
| 800       | 566244 \ 539853                 | 708 \ 675                                 |
| 900       | 635322 \ 483207                 | 706 \ 537                                 |
| 1000      | 698404 \ 471369                 | 698 \ 471                                 |
| 1100      | 770509 \ 423293                 | 700 \ 385                                 |
| 1200      | 844372 \ 517665                 | 704 \ 431                                 |
| 1300      | 900856 \ 628069                 | 693 \ 483                                 |
| 1400      | 774040 \ зависало...            | 553 \ зависало...                         |
| 1500      | 27227                           | 18                                        |
| 1600      | 107985                          | 67                                        |
| 1700      | 185168                          | 109                                       |
| 1800      | 243022                          | 135                                       |
| 1900      | 313416                          | 165                                       |
| 2000      | 382090                          | 191                                       |
| 2500      | 734652                          | 294                                       |

Для многопоточного сохранения данных наилучший результат показал `Clickhouse` (использовалась одновременная загрузка 1000 строк и синхронные библиотеки).

| Количество потоков | Среднее время загрузки 1 строки, микросек.|
|:-----------------: | :----------------------------------------:|
| 1                  | 35 \ 501                                  |
| 10                 | 77 \ 705                                  |
| 50                 | 177 \ зависало...                         |
| 100                | 330 \                                     |
| 200                | 430 \                                     |

На чтение гипотетического аналитического запроса `SELECT user_id, SUM(user_ts) FROM test GROUP BY user_id ORDER BY user_id ASC` наилучший результат показал `Clickhouse`.

| Количество строк в базе | Время выполнения запроса, микросек. |
|:----------------------: |:-----------------------------------:|
| 10 тысяч                | 10206 \ 889914                      |
| 100 тысяч               | 11940 \ 864061                      |
| 1 миллион               | 14988 \ 960710                      |

### Вывод

По всем оцененным показателям выигрывает хранилище `Clickhouse`. В дополнение к этому оно имеет подробную документацию на русском языке.


## OLAPs для сервиса UGC_2

* `Clickhouse` (1 нода)
* `Clickhouse` (2 ноды)
* `Clickhouse` (4 ноды)
* `Vertica` (1 нода)
* `Postgres` (1 нода)
* `MongoDB` (1 нода)
* `MongoDB` (2 ноды)

### Условия

Испытания проводились с предполагаемым дизайном рейтинга фильмов сервиса UGC_2 (схема данных `schemas.py`). Результаты считались по 10 итерациям, как средние арифметические.

### Результаты

На чтение пользовательского запроса, характерного для сервиса UGC_2 `SELECT rating FROM benchmarks.test WHERE user_id == a61caf17-879f-4773-91d0-298bea38d9ff` наилучший результат показал `MongoDB`.

| Хранилище           | Количество строк в базе | Время выполнения запроса, микросек. |
|:--------------------|:----------------------: |:-----------------------------------:|
| Clickhouse (1 нода) | 10 миллионов            | 111468                              |
| Clickhouse (2 ноды) | 10 миллионов            | 173819                              |
| Clickhouse (4 ноды) | 10 миллионов            | 138293                              |
| Vertica (1 нода)    | 10 миллионов            | 144790                              |
| Postgres (1 нода)   | 10 миллионов            | 412510                              |
| MongoDB (1 нода)    | 10 миллионов            | 354254                              |
| MongoDB (2 ноды)    | 10 миллионов            | 51468                               |

### Вывод

Для сервиса UGC_2 выигрывает хранилище `MongoDB`.
